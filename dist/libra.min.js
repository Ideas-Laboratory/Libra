var L={},tt=[],d=class{constructor(t,e){var r,s,l,a,n,o,c,h,u;e.preInitialize&&e.preInitialize.call(this,this),this._baseName=t,this._userOptions=e,this._name=(r=e.name)!==null&&r!==void 0?r:t,this._feedbacks=(s=e.feedback)!==null&&s!==void 0?s:[],this._undo=(l=e.undo)!==null&&l!==void 0?l:null,this._redo=(a=e.redo)!==null&&a!==void 0?a:null,this._execute=(n=e.execute)!==null&&n!==void 0?n:null,this._preInitialize=(o=e.preInitialize)!==null&&o!==void 0?o:null,this._postInitialize=(c=e.postInitialize)!==null&&c!==void 0?c:null,this._preExecute=(h=e.preExecute)!==null&&h!==void 0?h:null,this._postExecute=(u=e.postExecute)!==null&&u!==void 0?u:null,e.postInitialize&&e.postInitialize.call(this,this)}undo(){this._undo&&this._undo.call(this)}redo(){this._redo&&this._redo.call(this)}execute(t){this.preExecute(),this._execute&&this._execute.call(this,t),this.postExecute()}preExecute(){this._preExecute&&this._preExecute.call(this,this)}postExecute(){this._postExecute&&this._postExecute.call(this,this)}isInstanceOf(t){return this._baseName===t||this._name===t}};function A(i,t){L[i]=t}function j(i,t){var e;let r=Object.assign({},(e=L[i])!==null&&e!==void 0?e:{constructor:d},t);return new r.constructor(i,r)}function W(i){return tt.filter(t=>t.isInstanceOf(i))}d.register=A;d.initialize=j;d.findCommand=W;var p=d;var y={},et=[],f=class{constructor(t,e){var r,s,l,a,n,o,c,h;e.preInitialize&&e.preInitialize.call(this,this),this._preInitialize=(r=e.preInitialize)!==null&&r!==void 0?r:null,this._postInitialize=(s=e.postInitialize)!==null&&s!==void 0?s:null,this._preUse=(l=e.preUse)!==null&&l!==void 0?l:null,this._postUse=(a=e.postUse)!==null&&a!==void 0?a:null,this._baseName=t,this._userOptions=e,this._name=(n=e.name)!==null&&n!==void 0?n:t,this._on=(o=e.on)!==null&&o!==void 0?o:{},this._interactors=(c=e.interactors)!==null&&c!==void 0?c:[],this._layers=[],e.layers&&e.layers.forEach(u=>{"options"in u?this.attach(u.layer,u.options):this.attach(u)}),this._sharedVar=(h=e.sharedVar)!==null&&h!==void 0?h:{},e.postInitialize&&e.postInitialize.call(this,this)}on(t,e){this._on[t]=e}use(t,e){t.preUse(this),arguments.length>=2?this._interactors.push({interactor:t,options:e}):this._interactors.push(t),t.postUse(this)}attach(t,e){this.preUse(t),arguments.length>=2?this._layers.push({layer:t,options:e}):this._layers.push(t),this.postUse(t)}getSharedVar(t,e){return!(t in this._sharedVar)&&"defaultValue"in e&&this.setSharedVar(t,e.defaultValue,e),this._sharedVar[t]}setSharedVar(t,e,r){if(this._sharedVar[t]=e,this._on[`update:${t}`]){let s=this._on[`update:${t}`];s instanceof p?s.execute({self:this,layer:null,instrument:this,interactor:null}):s({self:this,layer:null,instrument:this,interactor:null})}}watchSharedVar(t,e){this.on(`update:${t}`,e)}preUse(t){this._preUse&&this._preUse.call(this,this,t)}postUse(t){this._postUse&&this._postUse.call(this,this,t)}isInstanceOf(t){return this._baseName===t||this._name===t}};function M(i,t){y[i]=t}function T(i,t){var e,r,s,l;let a=Object.assign({},(e=y[i])!==null&&e!==void 0?e:{constructor:f},t,{on:Object.assign({},(s=((r=y[i])!==null&&r!==void 0?r:{}).on)!==null&&s!==void 0?s:{},(l=t.on)!==null&&l!==void 0?l:{})});return new a.constructor(i,a)}function R(i){return et.filter(t=>t.isInstanceOf(i))}f.register=M;f.initialize=T;f.findInstrument=R;var C=f;function V(i){return new Proxy(i,{get(t,e){if(e==="find")return r=>V(t.filter(s=>s.isInstanceOf(r)))}})}function k(i){return G(i.trim()).map(w)}var it="view",I="[",x="]",B="{",$="}",rt=":",F=",",st="@",nt=">",at=/[[\]{}]/,lt=it,ot={"*":1,arc:1,area:1,group:1,image:1,line:1,path:1,rect:1,rule:1,shape:1,symbol:1,text:1,trail:1},ct=ot;function ht(i){return ct.hasOwnProperty(i)}function g(i,t,e,r,s){let l=0,a,n=i.length;for(;t<n;++t){if(a=i[t],!l&&a===e)return t;s&&s.indexOf(a)>=0?--l:r&&r.indexOf(a)>=0&&++l}return t}function G(i){let t=[],e=i.length,r=0,s=0;for(;s<e;)s=g(i,s,F,I+B,x+$),t.push(i.substring(r,s).trim()),r=++s;if(t.length===0)throw"Empty event selector: "+i;return t}function w(i){return i[0]==="["?ut(i):dt(i)}function ut(i){let t=i.length,e=1,r,s;if(e=g(i,e,x,I,x),e===t)throw"Empty between selector: "+i;if(r=G(i.substring(1,e)),r.length!==2)throw"Between selector must have two elements: "+i;if(i=i.slice(e+1).trim(),i[0]!==nt)throw"Expected '>' after between selector: "+i;let l=r.map(w);return s=w(i.slice(1).trim()),s.between?{between:l,stream:s}:(s.between=l,s)}function dt(i){let t={source:lt,type:""},e=[],r=[0,0],s=0,l=0,a=i.length,n=0,o,c;if(i[a-1]===$){if(n=i.lastIndexOf(B),n>=0){try{r=pt(i.substring(n+1,a-1))}catch(h){throw"Invalid throttle specification: "+i}i=i.slice(0,n).trim(),a=i.length}else throw"Unmatched right brace: "+i;n=0}if(!a)throw i;if(i[0]===st&&(s=++n),o=g(i,n,rt),o<a&&(e.push(i.substring(l,o).trim()),l=n=++o),n=g(i,n,I),n===a)e.push(i.substring(l,a).trim());else if(e.push(i.substring(l,n).trim()),c=[],l=++n,l===a)throw"Unmatched left bracket: "+i;for(;n<a;){if(n=g(i,n,x),n===a)throw"Unmatched left bracket: "+i;if(c.push(i.substring(l,n).trim()),n<a-1&&i[++n]!==I)throw"Expected left bracket: "+i;l=++n}if(!(a=e.length)||at.test(e[a-1]))throw"Invalid event selector: "+i;return a>1?(t.type=e[1],s?t.markname=e[0].slice(1):ht(e[0])?t.marktype=e[0]:t.source=e[0]):t.type=e[0],t.type.slice(-1)==="!"&&(t.consume=!0,t.type=t.type.slice(0,-1)),c!=null&&(t.filter=c),r[0]&&(t.throttle=r[0]),r[1]&&(t.debounce=r[1]),t}function pt(i){let t=i.split(F);if(!i.length||t.length>2)throw i;return t.map(function(e){let r=+e;if(r!==r)throw i;return r})}var K={},ft=[],_=class{constructor(t,e){var r,s,l,a,n,o;e.preInitialize&&e.preInitialize.call(this,this),this._baseName=t,this._userOptions=e,this._name=(r=e.name)!==null&&r!==void 0?r:t,this._state=e.state,this._actions=(s=e.actions)!==null&&s!==void 0?s:[],this._preInitialize=(l=e.preInitialize)!==null&&l!==void 0?l:null,this._postInitialize=(a=e.postInitialize)!==null&&a!==void 0?a:null,this._preUse=(n=e.preUse)!==null&&n!==void 0?n:null,this._postUse=(o=e.postUse)!==null&&o!==void 0?o:null,e.postInitialize&&e.postInitialize.call(this,this)}getActions(){return this._actions.slice(0)}setActions(t){this._actions=this._actions.concat(t)}_parseEvent(t){let e=r=>"stream"in r?r.between.concat(r.stream).flatMap(e):"between"in r?r.between.concat([{type:r.type}]).flatMap(e):r.type;return k(t).flatMap(e)}getAcceptEvents(){return this._actions.flatMap(t=>t.events.flatMap(e=>this._parseEvent(e)))}dispatch(t){let e=this._actions.find(r=>(t instanceof Event?r.events.includes(t.type):r.events.includes(t))&&(!r.transition||r.transition.find(s=>s[0]===this._state)));if(e){let r=e.transition&&e.transition.find(s=>s[0]===this._state);r&&(this._state=r[1]),e.sideEffect&&e.sideEffect({self:this,layer:null,instrument:null,interactor:this,event:t})}}preUse(t){this._preUse&&this._preUse.call(this,this,t)}postUse(t){this._postUse&&this._postUse.call(this,this,t)}isInstanceOf(t){return this._baseName===t||this._name===t}};function D(i,t){K[i]=t}function P(i,t){var e;let r=Object.assign({},(e=K[i])!==null&&e!==void 0?e:{constructor:_},t);return new r.constructor(i,r)}function q(i){return ft.filter(t=>t.isInstanceOf(i))}_.register=D;_.initialize=P;_.findInteractor=q;var O=_;var U={},_t=[],m=class{constructor(t,e){var r,s,l,a,n,o,c,h,u;e.preInitialize&&e.preInitialize.call(this,this),this._baseName=t,this._userOptions=e,this._name=(r=e.name)!==null&&r!==void 0?r:t,this._on=(s=e.on)!==null&&s!==void 0?s:{},this._sharedVar=(l=e.sharedVar)!==null&&l!==void 0?l:{},this._layerInstances=[],this._preInitialize=(a=e.preInitialize)!==null&&a!==void 0?a:null,this._postInitialize=(n=e.postInitialize)!==null&&n!==void 0?n:null,this._preUpdate=(o=e.preUpdate)!==null&&o!==void 0?o:null,this._postUpdate=(c=e.postUpdate)!==null&&c!==void 0?c:null,this._preUse=(h=e.preUse)!==null&&h!==void 0?h:null,this._postUse=(u=e.postUse)!==null&&u!==void 0?u:null,e.postInitialize&&e.postInitialize.call(this,this)}on(t,e){this._on[t]=e}getSharedVar(t,e){return!(t in this._sharedVar)&&"defaultValue"in e&&this.setSharedVar(t,e.defaultValue,e),this._sharedVar[t]}setSharedVar(t,e,r){this.preUpdate(),this._sharedVar[t]=e,this._on.update&&this._on.update.execute({self:this,layer:null,instrument:null,interactor:null}),this._on[`update:${t}`]&&this._on[`update:${t}`].execute({self:this,layer:null,instrument:null,interactor:null}),this.postUpdate()}watchSharedVar(t,e){this.on(`update:${t}`,e)}preUpdate(){this._preUpdate&&this._preUpdate.call(this,this)}postUpdate(){this._postUpdate&&this._postUpdate.call(this,this)}preUse(t){this._preUse&&this._preUse.call(this,this,t),this._layerInstances.push(t)}postUse(t){this._postUse&&this._postUse.call(this,this,t)}isInstanceOf(t){return this._baseName===t||this._name===t}};function H(i,t){U[i]=t}function J(i,t){var e,r,s,l,a,n,o;let c=Object.assign({},(e=U[i])!==null&&e!==void 0?e:{constructor:m},t,{on:Object.assign({},(s=((r=U[i])!==null&&r!==void 0?r:{}).on)!==null&&s!==void 0?s:{},(l=t.on)!==null&&l!==void 0?l:{}),sharedVar:Object.assign({},(n=((a=U[i])!==null&&a!==void 0?a:{}).sharedVar)!==null&&n!==void 0?n:{},(o=t.sharedVar)!==null&&o!==void 0?o:{})});return new c.constructor(i,c)}function E(i){return _t.filter(t=>t.isInstanceOf(i))}m.register=H;m.initialize=J;m.findService=E;var Q=E,b=m;var z={},X=[],v=class{constructor(t,e){var r,s,l,a,n,o,c,h;e.preInitialize&&e.preInitialize.call(this,this),this._baseName=t,this._userOptions=e,this._name=(r=e.name)!==null&&r!==void 0?r:t,this._transformation=(s=e.transformation)!==null&&s!==void 0?s:{},this._services=(l=e.services)!==null&&l!==void 0?l:[],this._container=e.container,this._sharedVar=(a=e.sharedVar)!==null&&a!==void 0?a:{},this._sharedVarWatcher={},this._transformationWatcher={},this._serviceInstances=[],this._redraw=e.redraw,this._preInitialize=(n=e.preInitialize)!==null&&n!==void 0?n:null,this._postInitialize=(o=e.postInitialize)!==null&&o!==void 0?o:null,this._preUpdate=(c=e.preUpdate)!==null&&c!==void 0?c:null,this._postUpdate=(h=e.postUpdate)!==null&&h!==void 0?h:null,this._services.forEach(u=>{typeof u=="string"||!("options"in u)?this.use(u):this.use(u.service,u.options)}),X.push(this),this._postInitialize&&this._postInitialize.call(this,this)}getGraphic(){return this._graphic}getContainerGraphic(){return this._container}getVisualElements(){return[]}getSharedVar(t,e){return t in this._sharedVar?this._sharedVar[t]:(this.setSharedVar(t,e),e)}setSharedVar(t,e){this.preUpdate();let r=this._sharedVar[t];this._sharedVar[t]=e,t in this._sharedVarWatcher&&this._sharedVarWatcher[t].forEach(s=>{s instanceof p?s.execute({self:this,layer:this,instrument:null,interactor:null,value:e,oldValue:r}):s({value:e,oldValue:r})}),this.postUpdate()}watchSharedVar(t,e){t in this._sharedVarWatcher||(this._sharedVarWatcher[t]=[]),this._sharedVarWatcher[t].push(e)}getTransformation(t,e){return t in this._transformation?this._transformation[t]:(this.setTransformation(t,e),e)}setTransformation(t,e){this.preUpdate();let r=this._transformation[t];this._transformation[t]=e,t in this._transformationWatcher&&this._transformationWatcher[t].forEach(s=>{s instanceof p?s.execute({self:this,layer:this,instrument:null,interactor:null,value:e,oldValue:r}):s({value:e,oldValue:r})}),this.postUpdate()}watchTransformation(t,e){t in this._transformationWatcher||(this._transformationWatcher[t]=[]),this._transformationWatcher[t].push(e)}redraw(t,e,r){this.preUpdate(),this._redraw&&this._redraw instanceof Function&&this._redraw(t,e,r),this.postUpdate()}preUpdate(){this._preUpdate&&this._preUpdate.call(this,this)}postUpdate(){this._postUpdate&&this._postUpdate.call(this,this)}query(t){return[]}_use(t,e){t.preUse(this),this._serviceInstances.push(t),t.postUse(this)}use(t,e){this._services.includes(t)||(arguments.length>=2?this._services.push({service:t,options:e}):this._services.push(t),typeof t=="string"?Q(t).forEach(s=>this._use(s,e)):this._use(t,e))}isInstanceOf(t){return this._baseName===t||this._name===t}get services(){return V(this._serviceInstances.slice(0))}};function Y(i,t){z[i]=t}function Z(i,t){var e,r,s,l,a,n,o;let c=Object.assign({},(e=z[i])!==null&&e!==void 0?e:{constructor:v},t,{transformation:Object.assign({},(s=((r=z[i])!==null&&r!==void 0?r:{}).transformation)!==null&&s!==void 0?s:{},(l=t.transformation)!==null&&l!==void 0?l:{}),sharedVar:Object.assign({},(n=((a=z[i])!==null&&a!==void 0?a:{}).sharedVar)!==null&&n!==void 0?n:{},(o=t.sharedVar)!==null&&o!==void 0?o:{})});return new c.constructor(i,c)}function N(i){return X.filter(t=>t.isInstanceOf(i))}v.register=Y;v.initialize=Z;v.findLayer=N;var S=v;var Ht={Command:p,Instrument:C,Interactor:O,Layer:S,InteractionService:b};export{p as Command,C as Instrument,b as InteractionService,O as Interactor,S as Layer,Ht as default};
