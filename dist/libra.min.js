var w={},X=[],d=class{constructor(t,e){var r,s,l,a,n,o,c,h,u;e.preInitialize&&e.preInitialize.call(this,this),this._baseName=t,this._userOptions=e,this._name=(r=e.name)!==null&&r!==void 0?r:t,this._feedbacks=(s=e.feedback)!==null&&s!==void 0?s:[],this._undo=(l=e.undo)!==null&&l!==void 0?l:null,this._redo=(a=e.redo)!==null&&a!==void 0?a:null,this._execute=(n=e.execute)!==null&&n!==void 0?n:null,this._preInitialize=(o=e.preInitialize)!==null&&o!==void 0?o:null,this._postInitialize=(c=e.postInitialize)!==null&&c!==void 0?c:null,this._preExecute=(h=e.preExecute)!==null&&h!==void 0?h:null,this._postExecute=(u=e.postExecute)!==null&&u!==void 0?u:null,e.postInitialize&&e.postInitialize.call(this,this)}undo(){this._undo&&this._undo.call(this)}redo(){this._redo&&this._redo.call(this)}execute(t){this.preExecute(),this._execute&&this._execute.call(this,t),this.postExecute()}preExecute(){this._preExecute&&this._preExecute.call(this,this)}postExecute(){this._postExecute&&this._postExecute.call(this,this)}isInstanceOf(t){return this._baseName===t||this._name===t}};function O(i,t){w[i]=t}function E(i,t){var e;let r=Object.assign({},(e=w[i])!==null&&e!==void 0?e:{constructor:d},t);return new r.constructor(i,r)}function S(i){return X.filter(t=>t.isInstanceOf(i))}d.register=O;d.initialize=E;d.findCommand=S;var v=d;var b={},Y=[],p=class{constructor(t,e){var r,s,l,a,n,o,c,h,u;e.preInitialize&&e.preInitialize.call(this,this),this._baseName=t,this._userOptions=e,this._name=(r=e.name)!==null&&r!==void 0?r:t,this._on=(s=e.on)!==null&&s!==void 0?s:{},this._interactors=(l=e.interactors)!==null&&l!==void 0?l:[],this._layers=(a=e.layers)!==null&&a!==void 0?a:[],this._sharedVar=(n=e.sharedVar)!==null&&n!==void 0?n:{},this._preInitialize=(o=e.preInitialize)!==null&&o!==void 0?o:null,this._postInitialize=(c=e.postInitialize)!==null&&c!==void 0?c:null,this._preUse=(h=e.preUse)!==null&&h!==void 0?h:null,this._postUse=(u=e.postUse)!==null&&u!==void 0?u:null,e.postInitialize&&e.postInitialize.call(this,this)}on(t,e){this._on[t]=e}use(t,e){t.preUse(this),arguments.length>=2?this._interactors.push({interactor:t,options:e}):this._interactors.push(t),t.postUse(this)}attach(t,e){this.preUse(t),arguments.length>=2?this._layers.push({layer:t,options:e}):this._layers.push(t),this.postUse(t)}getSharedVar(t,e){return!(t in this._sharedVar)&&"defaultValue"in e&&this.setSharedVar(t,e.defaultValue,e),this._sharedVar[t]}setSharedVar(t,e,r){if(this._sharedVar[t]=e,this._on[`update:${t}`]){let s=this._on[`update:${t}`];s instanceof v?s.execute({self:this,layer:null,instrument:this,interactor:null}):s({self:this,layer:null,instrument:this,interactor:null})}}watchSharedVar(t,e){this.on(`update:${t}`,e)}preUse(t){this._preUse&&this._preUse.call(this,this,t)}postUse(t){this._postUse&&this._postUse.call(this,this,t)}isInstanceOf(t){return this._baseName===t||this._name===t}};function L(i,t){b[i]=t}function A(i,t){var e;let r=Object.assign({},(e=b[i])!==null&&e!==void 0?e:{constructor:p},t);return new r.constructor(i,r)}function j(i){return Y.filter(t=>t.isInstanceOf(i))}p.register=L;p.initialize=A;p.findInstrument=j;var Z=p;function C(i){return new Proxy(i,{get(t,e){if(e==="find")return r=>C(t.filter(s=>s.isInstanceOf(r)))}})}function W(i){return k(i.trim()).map(V)}var N="view",I="[",x="]",M="{",T="}",tt=":",R=",",et="@",it=">",rt=/[[\]{}]/,st=N,nt={"*":1,arc:1,area:1,group:1,image:1,line:1,path:1,rect:1,rule:1,shape:1,symbol:1,text:1,trail:1},at=nt;function lt(i){return at.hasOwnProperty(i)}function g(i,t,e,r,s){let l=0,a,n=i.length;for(;t<n;++t){if(a=i[t],!l&&a===e)return t;s&&s.indexOf(a)>=0?--l:r&&r.indexOf(a)>=0&&++l}return t}function k(i){let t=[],e=i.length,r=0,s=0;for(;s<e;)s=g(i,s,R,I+M,x+T),t.push(i.substring(r,s).trim()),r=++s;if(t.length===0)throw"Empty event selector: "+i;return t}function V(i){return i[0]==="["?ot(i):ct(i)}function ot(i){let t=i.length,e=1,r,s;if(e=g(i,e,x,I,x),e===t)throw"Empty between selector: "+i;if(r=k(i.substring(1,e)),r.length!==2)throw"Between selector must have two elements: "+i;if(i=i.slice(e+1).trim(),i[0]!==it)throw"Expected '>' after between selector: "+i;let l=r.map(V);return s=V(i.slice(1).trim()),s.between?{between:l,stream:s}:(s.between=l,s)}function ct(i){let t={source:st,type:""},e=[],r=[0,0],s=0,l=0,a=i.length,n=0,o,c;if(i[a-1]===T){if(n=i.lastIndexOf(M),n>=0){try{r=ht(i.substring(n+1,a-1))}catch(h){throw"Invalid throttle specification: "+i}i=i.slice(0,n).trim(),a=i.length}else throw"Unmatched right brace: "+i;n=0}if(!a)throw i;if(i[0]===et&&(s=++n),o=g(i,n,tt),o<a&&(e.push(i.substring(l,o).trim()),l=n=++o),n=g(i,n,I),n===a)e.push(i.substring(l,a).trim());else if(e.push(i.substring(l,n).trim()),c=[],l=++n,l===a)throw"Unmatched left bracket: "+i;for(;n<a;){if(n=g(i,n,x),n===a)throw"Unmatched left bracket: "+i;if(c.push(i.substring(l,n).trim()),n<a-1&&i[++n]!==I)throw"Expected left bracket: "+i;l=++n}if(!(a=e.length)||rt.test(e[a-1]))throw"Invalid event selector: "+i;return a>1?(t.type=e[1],s?t.markname=e[0].slice(1):lt(e[0])?t.marktype=e[0]:t.source=e[0]):t.type=e[0],t.type.slice(-1)==="!"&&(t.consume=!0,t.type=t.type.slice(0,-1)),c!=null&&(t.filter=c),r[0]&&(t.throttle=r[0]),r[1]&&(t.debounce=r[1]),t}function ht(i){let t=i.split(R);if(!i.length||t.length>2)throw i;return t.map(function(e){let r=+e;if(r!==r)throw i;return r})}var B={},ut=[],f=class{constructor(t,e){var r,s,l,a,n,o;e.preInitialize&&e.preInitialize.call(this,this),this._baseName=t,this._userOptions=e,this._name=(r=e.name)!==null&&r!==void 0?r:t,this._state=e.state,this._actions=(s=e.actions)!==null&&s!==void 0?s:[],this._preInitialize=(l=e.preInitialize)!==null&&l!==void 0?l:null,this._postInitialize=(a=e.postInitialize)!==null&&a!==void 0?a:null,this._preUse=(n=e.preUse)!==null&&n!==void 0?n:null,this._postUse=(o=e.postUse)!==null&&o!==void 0?o:null,e.postInitialize&&e.postInitialize.call(this,this)}getActions(){return this._actions.slice(0)}setActions(t){this._actions=this._actions.concat(t)}_parseEvent(t){let e=r=>"stream"in r?r.stream.flatMap(e):r.type;return W(t).flatMap(e)}getAcceptEvents(){return this._actions.flatMap(t=>t.events.flatMap(e=>this._parseEvent(e)))}dispatch(t){let e=this._actions.find(r=>r.events.includes(t)&&(!r.transition||r.transition.find(s=>s[0]===this._state)));if(e){let r=e.transition&&e.transition.find(s=>s[0]===this._state);r&&(this._state=r[1]),e.sideEffect&&e.sideEffect({self:this,layer:null,instrument:null,interactor:this})}}preUse(t){this._preUse&&this._preUse.call(this,this,t)}postUse(t){this._postUse&&this._postUse.call(this,this,t)}isInstanceOf(t){return this._baseName===t||this._name===t}};function $(i,t){B[i]=t}function F(i,t){var e;let r=Object.assign({},(e=B[i])!==null&&e!==void 0?e:{constructor:f},t);return new r.constructor(i,r)}function G(i){return ut.filter(t=>t.isInstanceOf(i))}f.register=$;f.initialize=F;f.findInteractor=G;var dt=f;var U={},pt=[],_=class{constructor(t,e){var r,s,l,a,n,o,c,h,u;e.preInitialize&&e.preInitialize.call(this,this),this._baseName=t,this._userOptions=e,this._name=(r=e.name)!==null&&r!==void 0?r:t,this._on=(s=e.on)!==null&&s!==void 0?s:{},this._sharedVar=(l=e.sharedVar)!==null&&l!==void 0?l:{},this._layerInstances=[],this._preInitialize=(a=e.preInitialize)!==null&&a!==void 0?a:null,this._postInitialize=(n=e.postInitialize)!==null&&n!==void 0?n:null,this._preUpdate=(o=e.preUpdate)!==null&&o!==void 0?o:null,this._postUpdate=(c=e.postUpdate)!==null&&c!==void 0?c:null,this._preUse=(h=e.preUse)!==null&&h!==void 0?h:null,this._postUse=(u=e.postUse)!==null&&u!==void 0?u:null,e.postInitialize&&e.postInitialize.call(this,this)}on(t,e){this._on[t]=e}getSharedVar(t,e){return!(t in this._sharedVar)&&"defaultValue"in e&&this.setSharedVar(t,e.defaultValue,e),this._sharedVar[t]}setSharedVar(t,e,r){this.preUpdate(),this._sharedVar[t]=e,this._on.update&&this._on.update.execute({self:this,layer:null,instrument:null,interactor:null}),this._on[`update:${t}`]&&this._on[`update:${t}`].execute({self:this,layer:null,instrument:null,interactor:null}),this.postUpdate()}watchSharedVar(t,e){this.on(`update:${t}`,e)}preUpdate(){this._preUpdate&&this._preUpdate.call(this,this)}postUpdate(){this._postUpdate&&this._postUpdate.call(this,this)}preUse(t){this._preUse&&this._preUse.call(this,this,t),this._layerInstances.push(t)}postUse(t){this._postUse&&this._postUse.call(this,this,t)}isInstanceOf(t){return this._baseName===t||this._name===t}};function K(i,t){U[i]=t}function D(i,t){var e,r,s,l,a,n,o;let c=Object.assign({},(e=U[i])!==null&&e!==void 0?e:{constructor:_},t,{on:Object.assign({},(s=((r=U[i])!==null&&r!==void 0?r:{}).on)!==null&&s!==void 0?s:{},(l=t.on)!==null&&l!==void 0?l:{}),sharedVar:Object.assign({},(n=((a=U[i])!==null&&a!==void 0?a:{}).sharedVar)!==null&&n!==void 0?n:{},(o=t.sharedVar)!==null&&o!==void 0?o:{})});return new c.constructor(i,c)}function y(i){return pt.filter(t=>t.isInstanceOf(i))}_.register=K;_.initialize=D;_.findService=y;var P=y,ft=_;var z={},q=[],m=class{constructor(t,e){var r,s,l,a,n,o,c,h;e.preInitialize&&e.preInitialize.call(this,this),this._baseName=t,this._userOptions=e,this._name=(r=e.name)!==null&&r!==void 0?r:t,this._transformation=(s=e.transformation)!==null&&s!==void 0?s:{},this._services=(l=e.services)!==null&&l!==void 0?l:[],this._container=e.container,this._sharedVar=(a=e.sharedVar)!==null&&a!==void 0?a:{},this._sharedVarWatcher={},this._transformationWatcher={},this._serviceInstances=[],this._redraw=e.redraw,this._preInitialize=(n=e.preInitialize)!==null&&n!==void 0?n:null,this._postInitialize=(o=e.postInitialize)!==null&&o!==void 0?o:null,this._preUpdate=(c=e.preUpdate)!==null&&c!==void 0?c:null,this._postUpdate=(h=e.postUpdate)!==null&&h!==void 0?h:null,this._services.forEach(u=>{typeof u=="string"||!("options"in u)?this.use(u):this.use(u.service,u.options)}),q.push(this),this._postInitialize&&this._postInitialize.call(this,this)}getGraphic(){return this._graphic}getContainerGraphic(){return this._container}getVisualElements(){return[]}getSharedVar(t,e){return t in this._sharedVar?this._sharedVar[t]:(this.setSharedVar(t,e),e)}setSharedVar(t,e){this.preUpdate();let r=this._sharedVar[t];this._sharedVar[t]=e,t in this._sharedVarWatcher&&this._sharedVarWatcher[t].forEach(s=>{s instanceof v?s.execute({self:this,layer:this,instrument:null,interactor:null,value:e,oldValue:r}):s({value:e,oldValue:r})}),this.postUpdate()}watchSharedVar(t,e){t in this._sharedVarWatcher||(this._sharedVarWatcher[t]=[]),this._sharedVarWatcher[t].push(e)}getTransformation(t,e){return t in this._transformation?this._transformation[t]:(this.setTransformation(t,e),e)}setTransformation(t,e){this.preUpdate();let r=this._transformation[t];this._transformation[t]=e,t in this._transformationWatcher&&this._transformationWatcher[t].forEach(s=>{s instanceof v?s.execute({self:this,layer:this,instrument:null,interactor:null,value:e,oldValue:r}):s({value:e,oldValue:r})}),this.postUpdate()}watchTransformation(t,e){t in this._transformationWatcher||(this._transformationWatcher[t]=[]),this._transformationWatcher[t].push(e)}redraw(t,e,r){this.preUpdate(),this._redraw&&this._redraw instanceof Function&&this._redraw(t,e,r),this.postUpdate()}preUpdate(){this._preUpdate&&this._preUpdate.call(this,this)}postUpdate(){this._postUpdate&&this._postUpdate.call(this,this)}query(t){return[]}_use(t,e){t.preUse(this),this._serviceInstances.push(t),t.postUse(this)}use(t,e){this._services.includes(t)||(arguments.length>=2?this._services.push({service:t,options:e}):this._services.push(t),typeof t=="string"?P(t).forEach(s=>this._use(s,e)):this._use(t,e))}isInstanceOf(t){return this._baseName===t||this._name===t}get services(){return C(this._serviceInstances.slice(0))}};function H(i,t){z[i]=t}function J(i,t){var e,r,s,l,a,n,o;let c=Object.assign({},(e=z[i])!==null&&e!==void 0?e:{constructor:m},t,{transformation:Object.assign({},(s=((r=z[i])!==null&&r!==void 0?r:{}).transformation)!==null&&s!==void 0?s:{},(l=t.transformation)!==null&&l!==void 0?l:{}),sharedVar:Object.assign({},(n=((a=z[i])!==null&&a!==void 0?a:{}).sharedVar)!==null&&n!==void 0?n:{},(o=t.sharedVar)!==null&&o!==void 0?o:{})});return new c.constructor(i,c)}function Q(i){return q.filter(t=>t.isInstanceOf(i))}m.register=H;m.initialize=J;m.findLayer=Q;var _t=m;export{v as Command,Z as Instrument,ft as InteractionService,dt as Interactor,_t as Layer};
